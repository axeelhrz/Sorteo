"use strict";exports.id=31,exports.ids=[31],exports.modules={45144:(e,t,r)=>{r.d(t,{U:()=>i});var o=r(82986),a=r(26379),s=r(65373);let c=e=>e?.toDate?e.toDate():e instanceof Date?e:"string"==typeof e?new Date(e):new Date,d=async e=>{let t=e.data(),r={id:e.id,shopId:t.shopId||"",productId:t.productId||"",productValue:t.productValue||0,totalTickets:t.totalTickets||0,soldTickets:t.soldTickets||0,status:t.status||s.r.DRAFT,requiresDeposit:t.requiresDeposit||!1,winnerTicketId:t.winnerTicketId,specialConditions:t.specialConditions,createdAt:c(t.createdAt),updatedAt:c(t.updatedAt),activatedAt:t.activatedAt?c(t.activatedAt):void 0,raffleExecutedAt:t.raffleExecutedAt?c(t.raffleExecutedAt):void 0};if(t.shopId)try{let e=await (0,o.getDoc)((0,o.doc)(a.db,"shops",t.shopId));if(e.exists()){let t=e.data();r.shop={id:e.id,userId:t.userId||"",name:t.name||"",description:t.description,logo:t.logo,publicEmail:t.publicEmail,phone:t.phone,socialMedia:t.socialMedia,status:t.status||"pending",createdAt:c(t.createdAt),updatedAt:c(t.updatedAt)}}}catch(e){console.error("Error loading shop:",e)}if(t.productId)try{let e=await (0,o.getDoc)((0,o.doc)(a.db,"products",t.productId));if(e.exists()){let t=e.data();r.product={id:e.id,shopId:t.shopId||"",name:t.name||"",description:t.description||"",value:t.value||0,height:t.height||0,width:t.width||0,depth:t.depth||0,requiresDeposit:t.requiresDeposit||!1,category:t.category,mainImage:t.mainImage,status:t.status||"inactive",createdAt:c(t.createdAt),updatedAt:c(t.updatedAt)}}}catch(e){console.error("Error loading product:",e)}return r},i={async getActiveRaffles(e){try{let t;let r=(0,o.collection)(a.db,"raffles");try{let a=(0,o.query)(r,(0,o.where)("status","==",s.r.ACTIVE));if(e?.shopId&&(a=(0,o.query)(a,(0,o.where)("shopId","==",e.shopId))),e?.shopId)t=await (0,o.getDocs)(a);else try{a=e?.sortBy==="newest"?(0,o.query)(a,(0,o.Xo)("createdAt","desc")):e?.sortBy==="closest"?(0,o.query)(a,(0,o.Xo)("soldTickets","desc")):e?.sortBy==="price-asc"?(0,o.query)(a,(0,o.Xo)("productValue","asc")):e?.sortBy==="price-desc"?(0,o.query)(a,(0,o.Xo)("productValue","desc")):(0,o.query)(a,(0,o.Xo)("createdAt","desc")),t=await (0,o.getDocs)(a)}catch(c){console.warn("Error con orderBy, obteniendo sin ordenar:",c),a=e?.shopId?(0,o.query)(r,(0,o.where)("status","==",s.r.ACTIVE),(0,o.where)("shopId","==",e.shopId)):(0,o.query)(r,(0,o.where)("status","==",s.r.ACTIVE)),t=await (0,o.getDocs)(a)}}catch(c){console.warn("Error en consulta con where, obteniendo todos los sorteos:",c);let e=(0,o.query)(r),a=await (0,o.getDocs)(e);t={docs:a.docs.filter(e=>{let t=e.data().status;return t===s.r.ACTIVE||"active"===t})},console.log(`ðŸ“Š Sorteos activos encontrados despu\xe9s de filtrar: ${t.docs.length} de ${a.docs.length} totales`)}let c=[];for(let e of t.docs)try{let t=await d(e);c.push(t)}catch(e){console.error("Error converting raffle doc:",e)}if(console.log(`âœ… Sorteos activos cargados: ${c.length}`),e?.category&&(c=c.filter(t=>t.product?.category===e.category)),e?.minValue!==void 0&&(c=c.filter(t=>t.productValue>=e.minValue)),e?.maxValue!==void 0&&(c=c.filter(t=>t.productValue<=e.maxValue)),e?.search){let t=e.search.toLowerCase();c=c.filter(e=>e.product?.name.toLowerCase().includes(t)||e.product?.description.toLowerCase().includes(t)||e.shop?.name.toLowerCase().includes(t))}(e?.shopId||e?.sortBy)&&(e?.sortBy==="newest"?c.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()):e?.sortBy==="closest"?c.sort((e,t)=>t.soldTickets-e.soldTickets):e?.sortBy==="price-asc"?c.sort((e,t)=>e.productValue-t.productValue):e?.sortBy==="price-desc"&&c.sort((e,t)=>t.productValue-e.productValue));let i=e?.limit||12,l=e?.page||1,n=(l-1)*i,u=c.length;return{data:c.slice(n,n+i),total:u,page:l,limit:i,totalPages:Math.ceil(u/i)}}catch(e){throw console.error("Error fetching active raffles:",e),e}},async getRaffleById(e){try{let t=await (0,o.getDoc)((0,o.doc)(a.db,"raffles",e));if(!t.exists())throw Error("Raffle not found");return await d(t)}catch(e){throw console.error("Error fetching raffle:",e),e}},async getRafflesByShop(e,t){try{let r=(0,o.collection)(a.db,"raffles"),c=(0,o.query)(r,(0,o.where)("shopId","==",e),(0,o.where)("status","==",s.r.ACTIVE)),i=await (0,o.getDocs)(c),l=[];for(let e of i.docs){let t=await d(e);l.push(t)}if(t?.search){let e=t.search.toLowerCase();l=l.filter(t=>t.product?.name.toLowerCase().includes(e)||t.product?.description.toLowerCase().includes(e))}t?.sortBy==="newest"?l.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()):t?.sortBy==="closest"?l.sort((e,t)=>t.soldTickets-e.soldTickets):l.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime());let n=t?.limit||12,u=t?.page||1,p=(u-1)*n,f=l.length;return{data:l.slice(p,p+n),total:f,page:u,limit:n,totalPages:Math.ceil(f/n)}}catch(e){throw console.error("Error fetching shop raffles:",e),e}},async getCategories(){try{let e=(0,o.collection)(a.db,"products"),t=(0,o.query)(e,(0,o.where)("status","==","active")),r=await (0,o.getDocs)(t),s=new Set;return r.docs.forEach(e=>{let t=e.data();t.category&&s.add(t.category)}),Array.from(s).sort()}catch(e){return console.error("Error fetching categories:",e),[]}},async getShopsWithActiveRaffles(){try{let e=(0,o.collection)(a.db,"raffles"),t=(0,o.query)(e,(0,o.where)("status","==",s.r.ACTIVE)),r=await (0,o.getDocs)(t),c=new Set;r.docs.forEach(e=>{let t=e.data();t.shopId&&c.add(t.shopId)});let d=[];for(let e of c)try{let t=await (0,o.getDoc)((0,o.doc)(a.db,"shops",e));if(t.exists()){let e=t.data();d.push({id:t.id,name:e.name||"Tienda sin nombre"})}}catch(t){console.error(`Error loading shop ${e}:`,t)}return d.sort((e,t)=>e.name.localeCompare(t.name))}catch(e){return console.error("Error fetching shops:",e),[]}}}},31:(e,t,r)=>{r.d(t,{raffleService:()=>n});var o=r(82986),a=r(26379),s=r(65373);let c=e=>e?.toDate?e.toDate():e instanceof Date?e:"string"==typeof e?new Date(e):new Date,d=async e=>{let t=e.data();return{id:e.id,shopId:t.shopId||"",productId:t.productId||"",productValue:t.productValue||0,totalTickets:t.totalTickets||0,soldTickets:t.soldTickets||0,status:t.status||s.r.DRAFT,requiresDeposit:t.requiresDeposit||!1,winnerTicketId:t.winnerTicketId,specialConditions:t.specialConditions,createdAt:c(t.createdAt),updatedAt:c(t.updatedAt),activatedAt:t.activatedAt?c(t.activatedAt):void 0,raffleExecutedAt:t.raffleExecutedAt?c(t.raffleExecutedAt):void 0}},i={async createRaffle(e){try{let t=await (0,o.getDoc)((0,o.doc)(a.db,"products",e.productId));if(!t.exists())throw Error("Producto no encontrado");let r=t.data(),c=r.value||0,i=Math.floor(2*c);if(i<=0)throw Error("El valor del producto debe ser mayor a 0");let l=(0,o.collection)(a.db,"raffles"),n={shopId:e.shopId,productId:e.productId,productValue:c,totalTickets:i,soldTickets:0,status:s.r.DRAFT,requiresDeposit:r.requiresDeposit||!1,specialConditions:e.specialConditions||null,winnerTicketId:null,createdAt:(0,o.serverTimestamp)(),updatedAt:(0,o.serverTimestamp)()},u=await (0,o.ET)(l,n),p=await (0,o.getDoc)(u);if(!p.exists())throw Error("Error al crear el sorteo");return await d(p)}catch(e){throw console.error("Error creating raffle:",e),e}},async updateRaffle(e,t){try{let r=(0,o.doc)(a.db,"raffles",e),s={updatedAt:(0,o.serverTimestamp)()};void 0!==t.specialConditions&&(s.specialConditions=t.specialConditions),await (0,o.updateDoc)(r,s);let c=await (0,o.getDoc)(r);if(!c.exists())throw Error("Sorteo no encontrado");return await d(c)}catch(e){throw console.error("Error updating raffle:",e),e}},async submitForApproval(e){try{let t=(0,o.doc)(a.db,"raffles",e);await (0,o.updateDoc)(t,{status:s.r.PENDING_APPROVAL,updatedAt:(0,o.serverTimestamp)()});let r=await (0,o.getDoc)(t);if(!r.exists())throw Error("Sorteo no encontrado");return await d(r)}catch(e){throw console.error("Error submitting raffle for approval:",e),e}},async cancelRaffle(e){try{let t=(0,o.doc)(a.db,"raffles",e);await (0,o.updateDoc)(t,{status:s.r.CANCELLED,updatedAt:(0,o.serverTimestamp)()});let r=await (0,o.getDoc)(t);if(!r.exists())throw Error("Sorteo no encontrado");return await d(r)}catch(e){throw console.error("Error cancelling raffle:",e),e}}};var l=r(45144);let n={getRafflesByShop:async e=>(await l.U.getRafflesByShop(e,{limit:100})).data,getRaffleById:async e=>l.U.getRaffleById(e),getActiveRaffles:async()=>(await l.U.getActiveRaffles({limit:100})).data,async getAllRaffles(){let{collection:e,getDocs:t}=await Promise.resolve().then(r.bind(r,82986)),{db:o}=await Promise.resolve().then(r.bind(r,26379)),a=e(o,"raffles"),s=await t(a),c=[];for(let e of s.docs){let t=e.data();c.push({id:e.id,shopId:t.shopId||"",productId:t.productId||"",productValue:t.productValue||0,totalTickets:t.totalTickets||0,soldTickets:t.soldTickets||0,status:t.status||"draft",requiresDeposit:t.requiresDeposit||!1,winnerTicketId:t.winnerTicketId,specialConditions:t.specialConditions,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?.toDate()||new Date,activatedAt:t.activatedAt?.toDate(),raffleExecutedAt:t.raffleExecutedAt?.toDate()})}return c},createRaffle:async e=>i.createRaffle(e),updateRaffle:async(e,t)=>i.updateRaffle(e,t),submitForApproval:async e=>i.submitForApproval(e),cancelRaffle:async e=>i.cancelRaffle(e)}},65373:(e,t,r)=>{var o;r.d(t,{r:()=>o}),function(e){e.DRAFT="draft",e.PENDING_APPROVAL="pending_approval",e.ACTIVE="active",e.PAUSED="paused",e.SOLD_OUT="sold_out",e.FINISHED="finished",e.CANCELLED="cancelled",e.REJECTED="rejected"}(o||(o={}))}};