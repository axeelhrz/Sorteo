"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6204],{9273:function(e,t,o){o.d(t,{U:function(){return c}});var r=o(6534),a=o(6532),s=o(6030);let d=e=>(null==e?void 0:e.toDate)?e.toDate():e instanceof Date?e:"string"==typeof e?new Date(e):new Date,i=async e=>{let t=e.data(),o={id:e.id,shopId:t.shopId||"",productId:t.productId||"",productValue:t.productValue||0,totalTickets:t.totalTickets||0,soldTickets:t.soldTickets||0,status:t.status||s.r.DRAFT,requiresDeposit:t.requiresDeposit||!1,winnerTicketId:t.winnerTicketId,specialConditions:t.specialConditions,createdAt:d(t.createdAt),updatedAt:d(t.updatedAt),activatedAt:t.activatedAt?d(t.activatedAt):void 0,raffleExecutedAt:t.raffleExecutedAt?d(t.raffleExecutedAt):void 0};if(t.shopId)try{let e=await (0,r.getDoc)((0,r.doc)(a.db,"shops",t.shopId));if(e.exists()){let t=e.data();o.shop={id:e.id,userId:t.userId||"",name:t.name||"",description:t.description,logo:t.logo,publicEmail:t.publicEmail,phone:t.phone,socialMedia:t.socialMedia,status:t.status||"pending",createdAt:d(t.createdAt),updatedAt:d(t.updatedAt)}}}catch(e){console.error("Error loading shop:",e)}if(t.productId)try{let e=await (0,r.getDoc)((0,r.doc)(a.db,"products",t.productId));if(e.exists()){let t=e.data();o.product={id:e.id,shopId:t.shopId||"",name:t.name||"",description:t.description||"",value:t.value||0,height:t.height||0,width:t.width||0,depth:t.depth||0,requiresDeposit:t.requiresDeposit||!1,category:t.category,mainImage:t.mainImage,status:t.status||"inactive",createdAt:d(t.createdAt),updatedAt:d(t.updatedAt)}}}catch(e){console.error("Error loading product:",e)}return o},c={async getActiveRaffles(e){try{let t;let o=(0,r.collection)(a.db,"raffles");try{let a=(0,r.query)(o,(0,r.where)("status","==",s.r.ACTIVE));if((null==e?void 0:e.shopId)&&(a=(0,r.query)(a,(0,r.where)("shopId","==",e.shopId))),null==e?void 0:e.shopId)t=await (0,r.getDocs)(a);else try{a=(null==e?void 0:e.sortBy)==="newest"?(0,r.query)(a,(0,r.Xo)("createdAt","desc")):(null==e?void 0:e.sortBy)==="closest"?(0,r.query)(a,(0,r.Xo)("soldTickets","desc")):(null==e?void 0:e.sortBy)==="price-asc"?(0,r.query)(a,(0,r.Xo)("productValue","asc")):(null==e?void 0:e.sortBy)==="price-desc"?(0,r.query)(a,(0,r.Xo)("productValue","desc")):(0,r.query)(a,(0,r.Xo)("createdAt","desc")),t=await (0,r.getDocs)(a)}catch(d){console.warn("Error con orderBy, obteniendo sin ordenar:",d),a=(null==e?void 0:e.shopId)?(0,r.query)(o,(0,r.where)("status","==",s.r.ACTIVE),(0,r.where)("shopId","==",e.shopId)):(0,r.query)(o,(0,r.where)("status","==",s.r.ACTIVE)),t=await (0,r.getDocs)(a)}}catch(d){console.warn("Error en consulta con where, obteniendo todos los sorteos:",d);let e=(0,r.query)(o),a=await (0,r.getDocs)(e);t={docs:a.docs.filter(e=>{let t=e.data().status;return t===s.r.ACTIVE||"active"===t})},console.log("\uD83D\uDCCA Sorteos activos encontrados despu\xe9s de filtrar: ".concat(t.docs.length," de ").concat(a.docs.length," totales"))}let d=[];for(let e of t.docs)try{let t=await i(e);d.push(t)}catch(e){console.error("Error converting raffle doc:",e)}if(console.log("âœ… Sorteos activos cargados: ".concat(d.length)),(null==e?void 0:e.category)&&(d=d.filter(t=>{var o;return(null===(o=t.product)||void 0===o?void 0:o.category)===e.category})),(null==e?void 0:e.minValue)!==void 0&&(d=d.filter(t=>t.productValue>=e.minValue)),(null==e?void 0:e.maxValue)!==void 0&&(d=d.filter(t=>t.productValue<=e.maxValue)),null==e?void 0:e.search){let t=e.search.toLowerCase();d=d.filter(e=>{var o,r,a;return(null===(o=e.product)||void 0===o?void 0:o.name.toLowerCase().includes(t))||(null===(r=e.product)||void 0===r?void 0:r.description.toLowerCase().includes(t))||(null===(a=e.shop)||void 0===a?void 0:a.name.toLowerCase().includes(t))})}((null==e?void 0:e.shopId)||(null==e?void 0:e.sortBy))&&((null==e?void 0:e.sortBy)==="newest"?d.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()):(null==e?void 0:e.sortBy)==="closest"?d.sort((e,t)=>t.soldTickets-e.soldTickets):(null==e?void 0:e.sortBy)==="price-asc"?d.sort((e,t)=>e.productValue-t.productValue):(null==e?void 0:e.sortBy)==="price-desc"&&d.sort((e,t)=>t.productValue-e.productValue));let c=(null==e?void 0:e.limit)||12,l=(null==e?void 0:e.page)||1,n=(l-1)*c,u=d.length;return{data:d.slice(n,n+c),total:u,page:l,limit:c,totalPages:Math.ceil(u/c)}}catch(e){throw console.error("Error fetching active raffles:",e),e}},async getRaffleById(e){try{let t=await (0,r.getDoc)((0,r.doc)(a.db,"raffles",e));if(!t.exists())throw Error("Raffle not found");return await i(t)}catch(e){throw console.error("Error fetching raffle:",e),e}},async getRafflesByShop(e,t){try{let o=(0,r.collection)(a.db,"raffles"),d=(0,r.query)(o,(0,r.where)("shopId","==",e),(0,r.where)("status","==",s.r.ACTIVE)),c=await (0,r.getDocs)(d),l=[];for(let e of c.docs){let t=await i(e);l.push(t)}if(null==t?void 0:t.search){let e=t.search.toLowerCase();l=l.filter(t=>{var o,r;return(null===(o=t.product)||void 0===o?void 0:o.name.toLowerCase().includes(e))||(null===(r=t.product)||void 0===r?void 0:r.description.toLowerCase().includes(e))})}(null==t?void 0:t.sortBy)==="newest"?l.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()):(null==t?void 0:t.sortBy)==="closest"?l.sort((e,t)=>t.soldTickets-e.soldTickets):l.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime());let n=(null==t?void 0:t.limit)||12,u=(null==t?void 0:t.page)||1,p=(u-1)*n,f=l.length;return{data:l.slice(p,p+n),total:f,page:u,limit:n,totalPages:Math.ceil(f/n)}}catch(e){throw console.error("Error fetching shop raffles:",e),e}},async getCategories(){try{let e=(0,r.collection)(a.db,"products"),t=(0,r.query)(e,(0,r.where)("status","==","active")),o=await (0,r.getDocs)(t),s=new Set;return o.docs.forEach(e=>{let t=e.data();t.category&&s.add(t.category)}),Array.from(s).sort()}catch(e){return console.error("Error fetching categories:",e),[]}},async getShopsWithActiveRaffles(){try{let e=(0,r.collection)(a.db,"raffles"),t=(0,r.query)(e,(0,r.where)("status","==",s.r.ACTIVE)),o=await (0,r.getDocs)(t),d=new Set;o.docs.forEach(e=>{let t=e.data();t.shopId&&d.add(t.shopId)});let i=[];for(let e of d)try{let t=await (0,r.getDoc)((0,r.doc)(a.db,"shops",e));if(t.exists()){let e=t.data();i.push({id:t.id,name:e.name||"Tienda sin nombre"})}}catch(t){console.error("Error loading shop ".concat(e,":"),t)}return i.sort((e,t)=>e.name.localeCompare(t.name))}catch(e){return console.error("Error fetching shops:",e),[]}}}},6204:function(e,t,o){o.d(t,{raffleService:function(){return n}});var r=o(6534),a=o(6532),s=o(6030);let d=e=>(null==e?void 0:e.toDate)?e.toDate():e instanceof Date?e:"string"==typeof e?new Date(e):new Date,i=async e=>{let t=e.data();return{id:e.id,shopId:t.shopId||"",productId:t.productId||"",productValue:t.productValue||0,totalTickets:t.totalTickets||0,soldTickets:t.soldTickets||0,status:t.status||s.r.DRAFT,requiresDeposit:t.requiresDeposit||!1,winnerTicketId:t.winnerTicketId,specialConditions:t.specialConditions,createdAt:d(t.createdAt),updatedAt:d(t.updatedAt),activatedAt:t.activatedAt?d(t.activatedAt):void 0,raffleExecutedAt:t.raffleExecutedAt?d(t.raffleExecutedAt):void 0}},c={async createRaffle(e){try{let t=await (0,r.getDoc)((0,r.doc)(a.db,"products",e.productId));if(!t.exists())throw Error("Producto no encontrado");let o=t.data(),d=o.value||0,c=Math.floor(2*d);if(c<=0)throw Error("El valor del producto debe ser mayor a 0");let l=(0,r.collection)(a.db,"raffles"),n={shopId:e.shopId,productId:e.productId,productValue:d,totalTickets:c,soldTickets:0,status:s.r.DRAFT,requiresDeposit:o.requiresDeposit||!1,specialConditions:e.specialConditions||null,winnerTicketId:null,createdAt:(0,r.serverTimestamp)(),updatedAt:(0,r.serverTimestamp)()},u=await (0,r.ET)(l,n),p=await (0,r.getDoc)(u);if(!p.exists())throw Error("Error al crear el sorteo");return await i(p)}catch(e){throw console.error("Error creating raffle:",e),e}},async updateRaffle(e,t){try{let o=(0,r.doc)(a.db,"raffles",e),s={updatedAt:(0,r.serverTimestamp)()};void 0!==t.specialConditions&&(s.specialConditions=t.specialConditions),await (0,r.updateDoc)(o,s);let d=await (0,r.getDoc)(o);if(!d.exists())throw Error("Sorteo no encontrado");return await i(d)}catch(e){throw console.error("Error updating raffle:",e),e}},async submitForApproval(e){try{let t=(0,r.doc)(a.db,"raffles",e);await (0,r.updateDoc)(t,{status:s.r.PENDING_APPROVAL,updatedAt:(0,r.serverTimestamp)()});let o=await (0,r.getDoc)(t);if(!o.exists())throw Error("Sorteo no encontrado");return await i(o)}catch(e){throw console.error("Error submitting raffle for approval:",e),e}},async cancelRaffle(e){try{let t=(0,r.doc)(a.db,"raffles",e);await (0,r.updateDoc)(t,{status:s.r.CANCELLED,updatedAt:(0,r.serverTimestamp)()});let o=await (0,r.getDoc)(t);if(!o.exists())throw Error("Sorteo no encontrado");return await i(o)}catch(e){throw console.error("Error cancelling raffle:",e),e}}};var l=o(9273);let n={getRafflesByShop:async e=>(await l.U.getRafflesByShop(e,{limit:100})).data,getRaffleById:async e=>l.U.getRaffleById(e),getActiveRaffles:async()=>(await l.U.getActiveRaffles({limit:100})).data,async getAllRaffles(){let{collection:e,getDocs:t}=await Promise.resolve().then(o.bind(o,6534)),{db:r}=await Promise.resolve().then(o.bind(o,6532)),a=e(r,"raffles"),s=await t(a),d=[];for(let e of s.docs){var i,c,l,n;let t=e.data();d.push({id:e.id,shopId:t.shopId||"",productId:t.productId||"",productValue:t.productValue||0,totalTickets:t.totalTickets||0,soldTickets:t.soldTickets||0,status:t.status||"draft",requiresDeposit:t.requiresDeposit||!1,winnerTicketId:t.winnerTicketId,specialConditions:t.specialConditions,createdAt:(null===(i=t.createdAt)||void 0===i?void 0:i.toDate())||new Date,updatedAt:(null===(c=t.updatedAt)||void 0===c?void 0:c.toDate())||new Date,activatedAt:null===(l=t.activatedAt)||void 0===l?void 0:l.toDate(),raffleExecutedAt:null===(n=t.raffleExecutedAt)||void 0===n?void 0:n.toDate()})}return d},createRaffle:async e=>c.createRaffle(e),updateRaffle:async(e,t)=>c.updateRaffle(e,t),submitForApproval:async e=>c.submitForApproval(e),cancelRaffle:async e=>c.cancelRaffle(e)}},6030:function(e,t,o){var r,a;o.d(t,{r:function(){return r}}),(a=r||(r={})).DRAFT="draft",a.PENDING_APPROVAL="pending_approval",a.ACTIVE="active",a.PAUSED="paused",a.SOLD_OUT="sold_out",a.FINISHED="finished",a.CANCELLED="cancelled",a.REJECTED="rejected"}}]);